<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellbestätigung - Erziehen-Lernen-Fördern</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/base.css">
</head>

<body>
    <!-- Hauptinhalt -->
    <div class="page-content">
        <div class="container" style="margin-top: 120px;">
            <!-- Bestellbestätigung Header -->
            <div class="jumbotron bg-light">
                <h1 class="display-4">Vielen Dank für Ihre Bestellung!</h1>
                <p class="lead">Ihre Bestellung wurde erfolgreich aufgenommen.</p>
                <hr class="my-4">
                <p>Bestellnummer: <strong>ELF-2025-04-25-001</strong></p>
                <p>Bestellzeitpunkt: <strong>25.04.2025, 14:32 Uhr</strong></p>
                <p>Eine Bestätigungsmail wurde an Ihre E-Mail-Adresse gesendet.</p>
            </div>

            <!-- Bestellübersicht -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Bestellübersicht</h5>
                </div>
                <div class="card-body">
                    <!-- Artikel -->
                    <div class="row mb-3 border-bottom pb-3">
                        <div class="col-md-2">
                            <img src="http://localhost:3000/pictures/book_1/book_1_1.jpg" class="img-fluid" alt="Produkt">
                        </div>
                        <div class="col-md-7">
                            <h5>Mit Cuipsi den Mengen auf der Spur</h5>
                            <p class="mb-0">Kategorie: Buch</p>
                            <p class="mb-0">Menge: 1</p>
                        </div>
                        <div class="col-md-3 text-right">
                            <p class="mb-0">24,99 €</p>
                        </div>
                    </div>

                    <!-- Preiszusammenfassung -->
                    <div class="row">
                        <div class="col-md-9 text-right">
                            <p>Zwischensumme:</p>
                            <p>Versandkosten:</p>
                            <p><strong>Gesamtsumme:</strong></p>
                            <p><small>enthält 7% MwSt.:</small></p>
                        </div>
                        <div class="col-md-3 text-right">
                            <p>24,99 €</p>
                            <p>4,95 €</p>
                            <p><strong>29,94 €</strong></p>
                            <p><small>1,96 €</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liefer- und Zahlungsinformationen -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Lieferadresse</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">Max Mustermann</p>
                            <p class="mb-0">Musterstraße 123</p>
                            <p class="mb-0">12345 Musterstadt</p>
                            <p>Deutschland</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Zahlungsinformationen</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-0"><strong>Zahlungsart:</strong> Kreditkarte</p>
                            <p>VISA ****1234</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aktionsbuttons -->
            <div class="text-center mt-4 mb-5">
                <button class="btn btn-outline-secondary mr-2" onclick="window.print()">
                    <i class="bi bi-printer"></i> Bestellung drucken
                </button>
                <a href="index.html" class="btn btn-primary">
                    <i class="bi bi-house"></i> Zurück zur Startseite
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-lg-start mt-5">
        <div class="container p-4">
            <p>Kontakt: <a href="mailto:info@erziehen-lernen-foerdern.de">info@erziehen-lernen-foerdern.de</a></p>
            <ul class="list-inline">
                <li class="list-inline-item"><a href="imprint.html">Impressum</a></li>
                <li class="list-inline-item"><a href="payment-terms.html">Liefer- und Zahlungsbedingungen</a></li>
                <li class="list-inline-item"><a href="privacy-policy.html">Datenschutz</a></li>
            </ul>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const orderNumber = params.get('orderNumber');
            const pageContentContainer = document.querySelector('.page-content .container');

            if (!orderNumber) {
                pageContentContainer.innerHTML =
                    '<p class="text-center">Keine Bestellnummer gefunden. Bitte versuchen Sie es erneut oder kontaktieren Sie den Support.</p>';
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/orders/${orderNumber}`);
                if (!response.ok) {
                    let errorText = `Fehler beim Laden der Bestelldetails: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) { /* Ignore if response is not json */ }
                    throw new Error(errorText);
                }
                const orderDetails = await response.json();
                renderOrderConfirmation(orderDetails);
            } catch (error) {
                console.error('Fehler:', error);
                pageContentContainer.innerHTML =
                    `<p class="text-center">Fehler beim Laden Ihrer Bestellung: ${error.message}. Bitte kontaktieren Sie den Support.</p>`;
            }
        });

        function formatPriceGerman(price) {
            const numericPrice = Number(price);
            if (isNaN(numericPrice) || price === null || price === undefined) { return "N/A"; }
            return numericPrice.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function renderOrderConfirmation(orderDetails) {
            const jumbotron = document.querySelector('.jumbotron');
            if (jumbotron) {
                const strongElements = jumbotron.querySelectorAll('p strong');
                if (strongElements.length > 0) strongElements[0].textContent = orderDetails.order_number;

                const orderDate = new Date(orderDetails.order_date);
                if (strongElements.length > 1) strongElements[1].textContent =
                    `${orderDate.toLocaleDateString('de-DE')}, ${orderDate.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })} Uhr`;

                const paragraphs = jumbotron.querySelectorAll('p');
                if (paragraphs.length > 2) paragraphs[2].textContent = `Eine Bestätigungsmail wurde an ${orderDetails.customer_email} gesendet.`;
            }

            const orderOverviewCardBody = document.querySelector('.card .card-body'); // Assumes this is the "Bestellübersicht" card
            if (!orderOverviewCardBody) {
                console.error("Bestellübersicht Card Body nicht gefunden.");
                return;
            }

            let itemsHtml = '';
            orderDetails.items.forEach(item => {
                const imageUrl = item.firstImage ? item.firstImage : './pictures/logo_1/logo_1_1.jpg'; // Default placeholder
                itemsHtml += `
                    <div class="row mb-3 border-bottom pb-3">
                        <div class="col-md-2">
                            <img src="${imageUrl}" class="img-fluid" alt="${item.product_name}">
                        </div>
                        <div class="col-md-7">
                            <h5>${item.product_name}</h5>
                            <p class="mb-0">Menge: ${item.quantity}</p>
                        </div>
                        <div class="col-md-3 text-right">
                            <p class="mb-0">${formatPriceGerman(item.gross_price_at_purchase * item.quantity)} €</p>
                            ${item.quantity > 1 ? `<small class="text-muted">(${formatPriceGerman(item.gross_price_at_purchase)} € / Stück)</small>` : ''}
                        </div>
                    </div>
                `;
            });

            let vatSummary = {};
            orderDetails.items.forEach(item => {
                const item_total_net = item.net_price_at_purchase * item.quantity;
                const item_vat_amount = item_total_net * (item.vat_percentage_at_purchase / 100);
                const rate = parseFloat(item.vat_percentage_at_purchase).toFixed(0);
                if (vatSummary[rate]) {
                    vatSummary[rate] += item_vat_amount;
                } else {
                    vatSummary[rate] = item_vat_amount;
                }
            });

            let vatDetailsLabelsHtml = '';
            let vatDetailsValuesHtml = '';
            for (const rate in vatSummary) {
                if (vatSummary.hasOwnProperty(rate) && vatSummary[rate] > 0) {
                    vatDetailsLabelsHtml += `<p><small>enthält ${rate}% MwSt.:</small></p>`;
                    vatDetailsValuesHtml += `<p><small>${formatPriceGerman(vatSummary[rate])} €</small></p>`;
                }
            }

            const items_gross_total = orderDetails.items.reduce((sum, item) => sum + (item.gross_price_at_purchase * item.quantity), 0);

            const summaryHtml = `
                <hr>
                <div class="row">
                    <div class="col-md-9 text-right">
                        <p>Zwischensumme (Warenwert):</p>
                        <p>Versandkosten:</p>
                        <p><strong>Gesamtsumme:</strong></p>
                        ${vatDetailsLabelsHtml}
                    </div>
                    <div class="col-md-3 text-right">
                        <p>${formatPriceGerman(items_gross_total)} €</p>
                        <p>${formatPriceGerman(orderDetails.shipping_costs)} €</p>
                        <p><strong>${formatPriceGerman(orderDetails.total_gross_amount)} €</strong></p>
                        ${vatDetailsValuesHtml}
                    </div>
                </div>
            `;

            orderOverviewCardBody.innerHTML = itemsHtml + summaryHtml;

            const infoCards = document.querySelectorAll('.row .col-md-6 .card .card-body');
            if (infoCards.length > 0 && infoCards[0]) {
                 infoCards[0].innerHTML = `
                    <p class="mb-0">${orderDetails.customer_name}</p>
                    <p class="mb-0">${orderDetails.address_street}</p>
                    <p class="mb-0">${orderDetails.address_zip} ${orderDetails.address_city}</p>
                    <p>${orderDetails.address_country}</p>
                `;
            } else {
                console.error("Lieferadresse Card Body nicht gefunden.");
            }

            if (infoCards.length > 1 && infoCards[1]) {
                let paymentMethodDisplay = orderDetails.payment_method;
                const paymentMethodMap = {
                    'credit': 'Kreditkarte',
                    'vorkasse': 'Vorkasse',
                    'paypal': 'PayPal'
                };
                paymentMethodDisplay = paymentMethodMap[orderDetails.payment_method.toLowerCase()] || orderDetails.payment_method;

                infoCards[1].innerHTML = `
                    <p class="mb-0"><strong>Zahlungsart:</strong> ${paymentMethodDisplay}</p>
                `;
            } else {
                console.error("Zahlungsinformationen Card Body nicht gefunden.");
            }
        }
    </script>
</body>

</html>