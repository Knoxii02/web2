<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasse - Erziehen-Lernen-Fördern</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/checkout.css">
</head>

<body class="accent-color">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-md navbar-light fixed-top">
        <a class="navbar-brand" href="index.html">Erziehen-Lernen-Fördern</a>

        <!-- Cart Icon -->
        <a href="shopping-cart.html" class="cart-link nav-link ml-auto mr-3 order-md-last">
            <i class="bi bi-cart cart-icon"></i>
        </a>

        <!-- Toggler Button -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
            aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Einklappbarer Kontent -->
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav mr-auto">
                <a class="nav-link" href="index.html">Home</a>
                <a class="nav-link" href="shop.html">Shop</a>
                <a class="nav-link" href="contact.html">Kontakt</a>
            </div>
        </div>
    </nav>

    <!-- Hauptinhalt -->
    <div class="page-content">
        <div class="container mt-navbar">
            <!-- Seitentitel -->
            <div class="py-5 text-center">
                <img class="d-block mx-auto mb-4" src="http://localhost:3000/pictures/logo_1/logo_1_1.jpg" alt="Cuipsi Logo" width="72"
                    height="72">
                <h2>Bestellung abschließen</h2>
            </div>

            <div class="row">
                <!-- Bestellübersicht -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Übersicht</h5>
                        </div>
                        <div class="card-body">
                        </div>
                    </div>
                </div>

                <!-- Kundendaten und Zahlung -->
                <div class="col-md-8 order-md-1">
                    <div class="mb-4">
                        <h5>Lieferadresse</h5>
                        <form class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName">Vorname</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                    <div class="invalid-feedback">
                                        Bitte geben Sie Ihren Vornamen ein.
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName">Nachname</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                    <div class="invalid-feedback">
                                        Bitte geben Sie Ihren Nachnamen ein.
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="email">E-Mail</label>
                                <input type="email" class="form-control" id="email" required>
                                <div class="invalid-feedback">
                                    Bitte geben Sie eine gültige E-Mail-Adresse ein.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="address">Straße und Hausnummer</label>
                                <input type="text" class="form-control" id="address" required>
                                <div class="invalid-feedback">
                                    Bitte geben Sie Ihre Adresse ein.
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="zip">PLZ</label>
                                    <input type="text" class="form-control" id="zip" required>
                                    <div class="invalid-feedback">
                                        Bitte geben Sie eine Postleitzahl ein.
                                    </div>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label for="city">Ort</label>
                                    <input type="text" class="form-control" id="city" required>
                                    <div class="invalid-feedback">
                                        Bitte geben Sie eine Stadt ein.
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="country">Land</label>
                                <select class="custom-select" id="country" required>
                                    <option value="">Auswählen...</option>
                                    <option value="DE" selected>Deutschland</option>
                                    <option value="AT">Österreich</option>
                                    <option value="CH">Schweiz</option>
                                </select>
                                <div class="invalid-feedback">
                                    Bitte wählen Sie ein Land.
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Zahlungsmethoden -->
                    <div class="mb-4">
                        <h5>Zahlungsmethode</h5>
                        <div class="payment-methods">
                            <!-- Kreditkarte -->
                            <div class="custom-control custom-radio mb-2">
                                <input type="radio" id="credit" name="paymentMethod" class="custom-control-input"
                                    onchange="showPaymentDetails('credit')" checked>
                                <label class="custom-control-label" for="credit">Kreditkarte</label>
                            </div>
                            <div id="creditDetails" class="payment-details ml-4 mb-3">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label for="cc-number">Kartennummer</label>
                                        <input type="text" class="form-control" id="cc-number">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label for="cc-expiration">Gültig bis</label>
                                        <input type="text" class="form-control" id="cc-expiration" placeholder="MM/JJ">
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label for="cc-cvv">CVV</label>
                                        <input type="text" class="form-control" id="cc-cvv">
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <label for="cc-name">Karteninhaber</label>
                                    <input type="text" class="form-control" id="cc-name">
                                </div>
                            </div>

                            <!-- Vorkasse -->
                            <div class="custom-control custom-radio mb-2">
                                <input type="radio" id="vorkasse" name="paymentMethod" class="custom-control-input"
                                    onchange="showPaymentDetails('vorkasse')">
                                <label class="custom-control-label" for="vorkasse">Vorkasse</label>
                            </div>
                            <div id="vorkasseDetails" class="payment-details ml-4 mb-3" style="display: none;">
                                <div class="alert alert-info">
                                    <p class="mb-0">Bitte überweisen Sie den Betrag an:</p>
                                    <p class="mb-0">Kontoinhaber: Erziehen-Lernen-Fördern GmbH</p>
                                    <p class="mb-0">IBAN: DE12 3456 7890 1234 5678 90</p>
                                    <p class="mb-0">BIC: DEUTDEDBXXX</p>
                                    <p class="mb-0">Verwendungszweck: Ihre Bestellnummer (wird nach Abschluss angezeigt)
                                    </p>
                                </div>
                            </div>

                            <!-- PayPal -->
                            <div class="custom-control custom-radio">
                                <input type="radio" id="paypal" name="paymentMethod" class="custom-control-input"
                                    onchange="showPaymentDetails('paypal')">
                                <label class="custom-control-label" for="paypal">PayPal</label>
                            </div>
                        </div>
                    </div>

                    <!-- Bestellbutton -->
                    <hr class="mb-4">
                    <button class="btn btn-primary btn-lg btn-block" type="submit">Bestellung abschließen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-lg-start mt-5">
        <div class="container p-4">
            <p>Kontakt: <a href="mailto:info@erziehen-lernen-foerdern.de">info@erziehen-lernen-foerdern.de</a></p>
            <ul class="list-inline">
                <li class="list-inline-item"><a href="imprint.html">Impressum</a></li>
                <li class="list-inline-item"><a href="payment-terms.html">Liefer- und Zahlungsbedingungen</a></li>
                <li class="list-inline-item"><a href="privacy-policy.html">Datenschutz</a></li>
            </ul>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>

    <!-- Script für Formularvalidierung und Zahlungsmethoden -->
    <script>
        (function () {
            'use strict';
            window.addEventListener('load', function () {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        } else {
                            event.preventDefault();
                            window.location.href = 'confirmation.html';
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        function showPaymentDetails(method) {
            document.querySelectorAll('.payment-details').forEach(el => {
                el.style.display = 'none';
            });

            if (method !== 'paypal') {
                document.getElementById(method + 'Details').style.display = 'block';
            }
        }

        // This specific DOMContentLoaded listener for the submit button will be removed
        // and its logic integrated into the main async DOMContentLoaded below.
        // document.addEventListener('DOMContentLoaded', function () {
        //     const submitButton = document.querySelector('button[type="submit"]');
        //     submitButton.addEventListener('click', function (event) {
        //         const form = document.querySelector('.needs-validation');
        //         if (form.checkValidity()) {
        //             window.location.href = 'confirmation.html';
        //         } else {
        //             form.classList.add('was-validated');
        //         }
        //         event.preventDefault();
        //     });
        //
        //     const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
        //     submitButton.addEventListener('click', function (event) {
        //         let paymentSelected = false;
        //         paymentMethods.forEach(method => {
        //             if (method.checked) {
        //                 paymentSelected = true;
        //             }
        //         });
        //
        //         if (!paymentSelected) {
        //             alert('Bitte wählen Sie eine Zahlungsmethode aus.');
        //             event.preventDefault();
        //         }
        //     });
        // });

        function formatPriceGerman(price) {
            const numericPrice = Number(price);
            if (isNaN(numericPrice)) {
                return "N/A"; 
            }
            return numericPrice.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Variables declared at a higher scope to be accessible by summary and submit logic
            let products = [];
            let cart = [];
            let subtotal_net = 0;
            let total_gross_subtotal = 0;
            let final_total = 0;
            const shippingCost = 5.95; // This is constant as per previous steps
            let vat_amounts_by_rate = {};

            try {
                const productsResponse = await fetch('http://localhost:3000/api/products');
                products = await productsResponse.json(); // Assign to scoped products
                cart = JSON.parse(localStorage.getItem('cart')) || [];

                const productContainer = document.querySelector('.card-body');
                productContainer.innerHTML = ''; // Clear previous summary items

                // Recalculate summary details and store them in scoped variables
                subtotal_net = 0;
                vat_amounts_by_rate = {};

                cart.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        const productHTML = `
                            <h6 class="my-0">${product.name}</h6>
                            <small class="text-muted">${item.quantity} Stück</small>
                            <div class="mt-2 mb-2"></div>
                        `;
                        productContainer.insertAdjacentHTML('beforeend', productHTML);
                        subtotal_net += product.net_price * item.quantity;
                        const item_vat_amount = (product.net_price * item.quantity) * (product.vat_percentage / 100);
                        if (!vat_amounts_by_rate[product.vat_percentage]) {
                            vat_amounts_by_rate[product.vat_percentage] = 0;
                        }
                        vat_amounts_by_rate[product.vat_percentage] += item_vat_amount;
                    }
                });

                let total_vat_amount = 0;
                for (const rate in vat_amounts_by_rate) {
                    if (vat_amounts_by_rate.hasOwnProperty(rate)) {
                        total_vat_amount += vat_amounts_by_rate[rate];
                    }
                }

                total_gross_subtotal = subtotal_net + total_vat_amount; // Assign to scoped variable
                final_total = total_gross_subtotal + shippingCost; // Assign to scoped variable

                let vatDetailsHtml = '';
                for (const rate in vat_amounts_by_rate) {
                    if (vat_amounts_by_rate.hasOwnProperty(rate) && vat_amounts_by_rate[rate] > 0) {
                        vatDetailsHtml += `<small class="text-muted">enthält ${rate}% MwSt.: ${formatPriceGerman(vat_amounts_by_rate[rate])} €</small><br>`;
                    }
                }
                // Remove trailing <br> if it exists
                if (vatDetailsHtml.endsWith('<br>')) {
                    vatDetailsHtml = vatDetailsHtml.slice(0, -4);
                }

                productContainer.insertAdjacentHTML('beforeend', `
                    <div class="d-flex justify-content-between mt-3 mb-2">
                        <span>Zwischensumme:</span>
                        <span>${formatPriceGerman(total_gross_subtotal)} €</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Versandkosten:</span>
                        <span>${formatPriceGerman(shippingCost)} €</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Gesamtsumme:</strong>
                        <strong>${formatPriceGerman(final_total)} €</strong>
                    </div>
                    <div class="text-right">
                        ${vatDetailsHtml}
                    </div>
                `);
            } catch (error) {
                console.error('Fehler beim Laden der Produkte für die Zusammenfassung:', error);
                const productContainer = document.querySelector('.card-body');
                productContainer.innerHTML = '<p class="text-danger">Fehler beim Laden der Bestellübersicht.</p>';
            }

            // New submit handler logic
            const submitButton = document.querySelector('button[type="submit"]');
            const form = document.querySelector('.needs-validation');

            submitButton.addEventListener('click', async function (event) {
                event.preventDefault(); // Prevent default form submission in all cases for AJAX handling

                // Check payment method selection
                let paymentMethod = '';
                const paymentMethodRadios = document.querySelectorAll('input[name="paymentMethod"]');
                paymentMethodRadios.forEach(radio => {
                    if (radio.checked) {
                        paymentMethod = radio.id;
                    }
                });

                if (!paymentMethod) {
                    alert('Bitte wählen Sie eine Zahlungsmethode aus.');
                    form.classList.add('was-validated'); // Show other validation states
                    return;
                }

                // Validate form fields
                if (form.checkValidity() === false) {
                    form.classList.add('was-validated');
                    return;
                }
                form.classList.add('was-validated'); // Add class for styling, even if valid, before submission attempt

                // Collect data
                const customerDetails = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    zip: document.getElementById('zip').value,
                    city: document.getElementById('city').value,
                    country: document.getElementById('country').value
                };

                const itemsToSubmit = cart.map(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (!product) return null;
                    return {
                        productId: item.productId,
                        quantity: item.quantity,
                        net_price: product.net_price,
                        vat_percentage: product.vat_percentage
                    };
                }).filter(item => item !== null);

                const orderTotals = {
                    subtotal_net: subtotal_net,
                    shippingCost: shippingCost,
                    vat_amounts_by_rate: vat_amounts_by_rate,
                    final_total: final_total
                };

                // Send data to backend
                try {
                    const response = await fetch('http://localhost:3000/api/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            customerDetails: customerDetails,
                            paymentMethod: paymentMethod,
                            cartItems: itemsToSubmit,
                            totals: orderTotals
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler oder keine JSON-Antwort.' }));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    localStorage.removeItem('cart');
                    window.location.href = `confirmation.html?orderNumber=${result.orderNumber}`;

                } catch (error) {
                    console.error('Failed to submit order:', error);
                    let errorDiv = document.getElementById('checkout-error-message');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.id = 'checkout-error-message';
                        errorDiv.className = 'alert alert-danger mt-3';
                        // Insert it before the submit button's container or a prominent place
                        const buttonContainer = submitButton.parentNode;
                        buttonContainer.parentNode.insertBefore(errorDiv, buttonContainer.nextSibling); // Place it after the button or its container
                    }
                    errorDiv.textContent = 'Fehler beim Absenden der Bestellung: ' + error.message;
                }
            });
        });
    </script>
</body>

</html>